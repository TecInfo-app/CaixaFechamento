<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIA DO CHOPP - Gest√£o Firebase</title>
    <style>
        :root { --primary: #d14900; --secondary: #25d366; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        .nav { background: var(--primary); padding: 15px; display: flex; justify-content: center; gap: 10px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav button { background: white; border: none; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .container { max-width: 800px; margin: 20px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .hidden { display: none; }
        h2 { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .card { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 10px; background: #fff; }
        .flex-btns { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .btn-small { padding: 6px 12px; font-size: 13px; width: auto; margin: 0; }
        .badge-date { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 14px; }
        .obs-box { background: #f0f0f0; padding: 10px; border-radius: 6px; margin: 10px 0; font-style: italic; font-size: 14px; border-left: 4px solid var(--primary); }
        @media print { .nav, .btn, .no-print, .flex-btns { display: none !important; } .container { box-shadow: none; margin: 0; width: 100%; } }
    </style>
</head>
<body>

<div class="nav no-print">
    <button onclick="showScreen('screen-order')">üõí Novo Pedido</button>
    <button onclick="showScreen('screen-history')">üìã Encomendas</button>
    <button onclick="showScreen('screen-products')">üçî Card√°pio</button>
</div>

<div class="container">
    <div id="screen-order">
        <h2 id="order-title">üõçÔ∏è Nova Encomenda - CIA DO CHOPP</h2>
        <input type="hidden" id="edit-order-id">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="order-client" placeholder="Nome do Cliente" style="flex: 2;">
            <input type="tel" id="order-phone" placeholder="WhatsApp (DDD+N√∫mero)" style="flex: 1;">
        </div>
        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;"><label><small>Data Entrega:</small></label><input type="date" id="order-date"></div>
            <div style="flex: 1;"><label><small>Hora:</small></label><input type="time" id="order-time"></div>
        </div>

        <div id="render-menu-order">Carregando card√°pio...</div>

        <div style="margin-top: 20px;">
            <label><small>Observa√ß√µes Adicionais (opcional):</small></label>
            <textarea id="order-obs" placeholder="Ex: Sem cebola, molho √† parte, ponto da carne..."></textarea>
        </div>

        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: right;">
            <strong style="font-size: 20px;">Total Estimado: R$ <span id="total-val">0,00</span></strong>
            <button class="btn btn-success" id="btn-save-order" onclick="saveOrder()">Salvar Encomenda</button>
        </div>
    </div>

    <div id="screen-products" class="hidden">
        <h2 id="prod-title">üçî Card√°pio - CIA DO CHOPP</h2>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
            <input type="hidden" id="prod-id">
            <input type="text" id="prod-name" placeholder="Nome do Produto">
            <div style="display: flex; gap: 10px;">
                <input type="number" step="0.01" id="prod-price" placeholder="Pre√ßo">
                <select id="prod-unit">
                    <option value="kg">Por Kg (100g)</option>
                    <option value="un">Por Unidade</option>
                </select>
            </div>
            <button class="btn btn-primary" id="btn-prod-save" onclick="addProduct()">Salvar Produto</button>
            <button class="btn hidden" id="btn-prod-cancel" onclick="clearProdForm()" style="background:#666; color:white;">Cancelar</button>
        </div>
        <div id="render-products-list"></div>
    </div>

    <div id="screen-history" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>üìã Encomendas</h2>
            <button class="btn btn-small no-print" style="background:#333; color:white" onclick="window.print()">üñ®Ô∏è Imprimir Lista</button>
        </div>
        <div id="render-history-list"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCJ60tPxMyrC3HNHrdmCpFML0hzoMf1y2A",
        authDomain: "ciaencomendas-35ace.firebaseapp.com",
        projectId: "ciaencomendas-35ace",
        storageBucket: "ciaencomendas-35ace.firebasestorage.app",
        messagingSenderId: "704109381472",
        appId: "1:704109381472:web:2cd8c9309e660e32914005",
        databaseURL: "https://ciaencomendas-35ace-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let products = [];
    let orders = [];

    onValue(ref(db, 'products'), (snap) => {
        const data = snap.val();
        products = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
        renderProducts();
        renderMenuForOrder();
    });

    onValue(ref(db, 'orders'), (snap) => {
        const data = snap.val();
        orders = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
        renderHistory();
    });

    window.showScreen = (id) => {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    window.addProduct = async () => {
        const id = document.getElementById('prod-id').value;
        const name = document.getElementById('prod-name').value;
        const price = parseFloat(document.getElementById('prod-price').value);
        const unit = document.getElementById('prod-unit').value;
        if(!name || isNaN(price)) return alert("Preencha nome e pre√ßo!");
        const data = { name, price, unit };
        if(id) await update(ref(db, 'products/' + id), data);
        else await push(ref(db, 'products'), data);
        clearProdForm();
    };

    window.editProduct = (id) => {
        const p = products.find(item => item.id === id);
        document.getElementById('prod-id').value = p.id;
        document.getElementById('prod-name').value = p.name;
        document.getElementById('prod-price').value = p.price;
        document.getElementById('prod-unit').value = p.unit;
        document.getElementById('prod-title').innerText = "‚úèÔ∏è Editando Produto";
        document.getElementById('btn-prod-save').innerText = "Atualizar Produto";
        document.getElementById('btn-prod-cancel').classList.remove('hidden');
    };

    window.clearProdForm = () => {
        document.getElementById('prod-id').value = "";
        document.getElementById('prod-name').value = "";
        document.getElementById('prod-price').value = "";
        document.getElementById('prod-title').innerText = "üçî Card√°pio - CIA DO CHOPP";
        document.getElementById('btn-prod-save').innerText = "Salvar Produto";
        document.getElementById('btn-prod-cancel').classList.add('hidden');
    };

    window.saveOrder = async () => {
        const client = document.getElementById('order-client').value;
        const editId = document.getElementById('edit-order-id').value;
        if(!client) return alert("Nome do cliente obrigat√≥rio!");
        let items = [];
        document.querySelectorAll('.order-qty').forEach(input => {
            const qty = parseFloat(input.value) || 0;
            if(qty > 0) items.push({ name: input.dataset.name, qty, unit: input.dataset.unit });
        });
        if(items.length === 0) return alert("Selecione itens!");
        const orderData = { 
            client, 
            phone: document.getElementById('order-phone').value, 
            date: document.getElementById('order-date').value, 
            time: document.getElementById('order-time').value, 
            items, 
            total: document.getElementById('total-val').innerText,
            obs: document.getElementById('order-obs').value
        };
        if(editId) await update(ref(db, 'orders/' + editId), orderData);
        else await push(ref(db, 'orders'), orderData);
        alert("Pedido salvo!");
        location.reload();
    };

    window.editOrder = (id) => {
        const o = orders.find(ord => ord.id === id);
        showScreen('screen-order');
        document.getElementById('edit-order-id').value = o.id;
        document.getElementById('order-client').value = o.client;
        document.getElementById('order-phone').value = o.phone;
        document.getElementById('order-date').value = o.date;
        document.getElementById('order-time').value = o.time;
        document.getElementById('order-obs').value = o.obs || "";
        setTimeout(() => {
            document.querySelectorAll('.order-qty').forEach(input => {
                const item = o.items.find(i => i.name === input.dataset.name);
                input.value = item ? item.qty : "";
            });
            window.calcTotal();
        }, 200);
    };

    window.sendWhatsApp = (id) => {
        const o = orders.find(ord => ord.id === id);
        let msg = `*CIA DO CHOPP - RESUMO DA ENCOMENDA*\n\n`;
        msg += `Ol√° ${o.client}!\nüìÖ Data: ${o.date ? o.date.split('-').reverse().join('/') : ''}\n‚è∞ Hora: ${o.time || '--:--'}\n\n`;
        o.items.forEach(i => { msg += `‚úÖ ${i.qty}${i.unit} - ${i.name}\n`; });
        if(o.obs) msg += `\nüìù *OBS:* ${o.obs}\n`;
        msg += `\n*TOTAL ESTIMADO: R$ ${o.total}*`;
        msg += `\n\n_Obs: O valor informado √© uma estimativa e pode variar para mais ou para menos de acordo com o peso final dos produtos no momento da entrega._`;
        window.open(`https://wa.me/55${o.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.calcTotal = () => {
        let total = 0;
        document.querySelectorAll('.order-qty').forEach(input => {
            const val = parseFloat(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            total += (input.dataset.unit === 'kg') ? val * (price * 10) : val * price;
        });
        document.getElementById('total-val').innerText = total.toFixed(2).replace('.',',');
    };

    function renderProducts() {
        document.getElementById('render-products-list').innerHTML = products.map(p => `
            <div class="card">
                <strong>${p.name}</strong> - R$ ${p.price.toFixed(2)} (${p.unit})
                <div class="flex-btns">
                    <button class="btn btn-small btn-primary" onclick="editProduct('${p.id}')">‚úèÔ∏è Editar</button>
                    <button class="btn btn-small" style="background:red;color:white" onclick="remove(ref(db, 'products/${p.id}'))">üóëÔ∏è Excluir</button>
                </div>
            </div>`).join('');
    }

    function renderMenuForOrder() {
        document.getElementById('render-menu-order').innerHTML = "<h3>Itens:</h3>" + products.map(p => `
            <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; align-items:center;">
                <div style="flex:1"><b>${p.name}</b><br><small>R$ ${p.price}/${p.unit === 'kg' ? '100g' : 'un'}</small></div>
                <input type="number" step="0.1" class="order-qty" data-name="${p.name}" data-price="${p.price}" data-unit="${p.unit}" oninput="calcTotal()" style="width:80px;">
            </div>`).join('');
    }

    function renderHistory() {
        const sorted = orders.sort((a,b) => new Date(a.date) - new Date(b.date));
        document.getElementById('render-history-list').innerHTML = sorted.map(o => `
            <div class="card">
                <strong>üë§ ${o.client}</strong> - üìÖ ${o.date ? o.date.split('-').reverse().join('/') : '--'}<br>
                <div style="margin:8px 0;">${o.items.map(i => `‚Ä¢ ${i.qty}${i.unit} ${i.name}`).join('<br>')}</div>
                ${o.obs ? `<div class="obs-box"><b>Obs:</b> ${o.obs}</div>` : ''}
                <strong>Total: R$ ${o.total}</strong>
                <div class="flex-btns no-print">
                    <button class="btn btn-small btn-primary" onclick="editOrder('${o.id}')">‚úèÔ∏è Editar</button>
                    <button class="btn btn-small btn-success" onclick="sendWhatsApp('${o.id}')">üì± WhatsApp</button>
                    <button class="btn btn-small" style="background:red;color:white" onclick="remove(ref(db, 'orders/${o.id}'))">üóëÔ∏è Excluir</button>
                </div>
            </div>`).join('');
    }
</script>
</body>
</html>
